<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NavyRadar â€” Flightradar24 clone (MVP)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100vh;
            width: 100vw;
            display: block;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', {
            worldCopyJump: false,
            maxBounds: [
                [-85, -180],
                [85, 180]
            ],
            maxBoundsViscosity: 1.0,
            minZoom: 3,
            maxZoom: 19
        }).setView([20, 0], 2);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            noWrap: true,
            bounds: [
                [-85, -180],
                [85, 180]
            ],
            minZoom: 2,
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        const shipLayer = L.layerGroup().addTo(map);
        const markers = new Map();

        async function getShipData(id) {
            try {
                const res = await fetch(`http://localhost:3000/ships/${id}`);
                const data = await res.json();
                console.log('Ship data', data);
            } catch (err) {
                console.error('Ship fetch error', err);
                window.shipResult = JSON.stringify({ error: err.message });
            }
        }

        function upsertShip(ship) {
            const id = ship.Id;
            const style = {
                radius: 6,
                color: '#0077be',
                weight: 0.5,
                fillColor: '#0077be',
                fillOpacity: 0.95
            };

            // Remove old marker if exists
            if (markers.has(id)) {
                shipLayer.removeLayer(markers.get(id));
                markers.delete(id);
            }

            const lat = ship.CurrentPosition.latitude;
            const lon = ship.CurrentPosition.longitude;
            const m = L.circleMarker([lat, lon], style);
            m.on('click', () => {
                map.panTo(m.getLatLng());
                window.chrome.webview.hostObjects.bridge.SelectShip(id);
                getShipData(id);
            });
            m.bindTooltip(`${ship.Name}<br>${ship.Type}<br>Speed: ${ship.Speed} kn`);
            m.addTo(shipLayer);
            markers.set(id, m);
        }

        function removeShip(id) {
            if (markers.has(id)) {
                shipLayer.removeLayer(markers.get(id));
                markers.delete(id);
            }
        }

        let ws;
        function connectWs() {
            ws = new WebSocket('ws://localhost:3000/realtime');
            ws.onopen = () => console.info('ws open');
            ws.onmessage = (ev) => {
                try {
                    const msg = JSON.parse(ev.data);
                    if (msg.type === 'update' && Array.isArray(msg.data)) {
                        msg.data.forEach(upsertShip);
                    } else if (msg.type === 'remove') {
                        removeShip(msg.Id);
                    }
                } catch (e) { console.error('ws parse', e); }
            };
            ws.onclose = () => setTimeout(connectWs, 3000);
        }
        connectWs();
    </script>
</body>

</html>