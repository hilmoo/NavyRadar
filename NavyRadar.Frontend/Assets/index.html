<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>NavyRadar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100vh;
            width: 100vw;
            display: block;
        }
    </style>
</head>

<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {
        worldCopyJump: false,
        maxBounds: [
            [-85, -180],
            [85, 180]
        ],
        maxBoundsViscosity: 1.0,
        minZoom: 3,
        maxZoom: 19
    }).setView([-7.49, 110.0], 7);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        noWrap: true,
        bounds: [
            [-85, -180],
            [85, 180]
        ],
        minZoom: 2,
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    const portLayer = L.layerGroup().addTo(map);
    const portStyle = {
        radius: 7,
        color: '#004d00',
        weight: 1,
        fillColor: '#009900',
        fillOpacity: 0.9
    };

    async function loadPorts() {
        try {
            const res = await fetch('http://localhost:5000/api/Ports');
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const apiPorts = await res.json();

            apiPorts.forEach(port => {
                const lat = port.location.y;
                const lon = port.location.x;
                const name = port.name;
                const m = L.circleMarker([lat, lon], portStyle);
                m.bindTooltip(name);
                m.addTo(portLayer);
                m.on('click', () => {
                    const portId = port.id;
                    window.chrome.webview.postMessage({
                        type: 'portSelected',
                        id: portId
                    });
                });
            });

        } catch (err) {
            console.error('Error loading ports:', err);
        }
    }

    loadPorts();


    const shipLayer = L.layerGroup().addTo(map);
    const markers = new Map();

    function getShipTypeKey(shipType) {
        if (!shipType) return '';
        let key = shipType.replace(/\s+/g, '');
        return key.charAt(0).toLowerCase() + key.slice(1);
    }

    let currentFilter = {
        shipName: '',
        types: null
    };

    function upsertShip(sail) {
        const id = sail.shipId;
        const style = {
            radius: 6,
            color: '#0077be',
            weight: 0.5,
            fillColor: '#0077be',
            fillOpacity: 0.95
        };

        const lat = sail.coordinates.y;
        const lon = sail.coordinates.x;
        const m = L.circleMarker([lat, lon], style);

        m.bindTooltip(sail.shipName);

        m.on('click', () => {
            window.chrome.webview.postMessage({
                type: 'shipSelected',
                shipId: sail.shipId,
                sailId: sail.sailId
            });
        });

        m.addTo(shipLayer);
        markers.set(id, m);
    }

    function hasActiveTypes(typesObj) {
        if (!typesObj || typeof typesObj !== 'object') return false;
        return Object.values(typesObj).some(v => v === true);
    }

    async function loadShips() {
        try {
            const res = await fetch('http://localhost:5000/api/Sails/active');
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const apiSails = await res.json();

            shipLayer.clearLayers();
            markers.clear();

            const filteredSails = apiSails.filter(sail => {
                const nameFilter = (currentFilter.shipName || '').toLowerCase();
                const shipName = (sail.shipName || '').toLowerCase();
                const nameMatch = shipName.includes(nameFilter);

                let typeMatch = true;
                if (currentFilter.types && hasActiveTypes(currentFilter.types)) {
                    const typeKey = getShipTypeKey(sail.shipType);
                    typeMatch = currentFilter.types[typeKey] === true;
                }

                return nameMatch && typeMatch;
            });

            filteredSails.forEach(sail => upsertShip(sail));

        } catch (err) {
            console.error('Error loading ships:', err);
        }
    }

    loadShips();

    setInterval(loadShips, 10000);

    function filterShip(message) {
        console.log("Applying filter:", message);

        if (!message || Object.keys(message).length === 0) {
            currentFilter.shipName = '';
            currentFilter.types = null;
        } else {
            currentFilter.shipName = message.shipName || '';

            if (message.types && typeof message.types === 'object' && hasActiveTypes(message.types)) {
                currentFilter.types = message.types;
            } else {
                currentFilter.types = null;
            }
        }

        loadShips();
    }
</script>
</body>

</html>