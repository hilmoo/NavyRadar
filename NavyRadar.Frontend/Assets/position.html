<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>NavyRadar - Ship History</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        html, body { height: 100%; margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; display: block; }

        .custom-tooltip {
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }
        .legend-title { font-weight: 600; margin-bottom: 8px; color: #333; }
        .gradient-bar {
            width: 120px;
            height: 12px;
            background: linear-gradient(to right, #3b82f6, #8b5cf6, #ec4899);
            border-radius: 4px;
            margin-bottom: 4px;
        }
        .legend-labels {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 10px;
        }

        .pulse-marker {
            width: 16px;
            height: 16px;
            background: #ec4899;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 rgba(236, 72, 153, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.5); }
            70% { box-shadow: 0 0 0 12px rgba(236, 72, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
        }

        .leaflet-control-refresh-btn:hover {
            background-color: #f4f4f4;
        }

        .port-icon {
            background: transparent;
            border: none;
        }

        #loading-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.4);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: #333;
            display: none;
            align-items: center;
            pointer-events: none;
        }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid #ccc;
            border-top-color: #333;
            border-radius: 50%;
            margin-right: 8px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="loading-indicator">
    <div class="spinner"></div>
    <span>Updating Data...</span>
</div>
<div class="legend">
    <div class="legend-title">üìç Traversal Path</div>
    <div class="gradient-bar"></div>
    <div class="legend-labels">
        <span id="start-time">Oldest</span>
        <span id="end-time">Latest</span>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const loaderElement = document.getElementById('loading-indicator');
    let activeRequests = 0;

    function showLoader() {
        activeRequests++;
        loaderElement.style.display = 'flex';
    }

    function hideLoader() {
        activeRequests--;
        if (activeRequests <= 0) {
            activeRequests = 0;
            loaderElement.style.display = 'none';
        }
    }

    const map = L.map('map', {
        worldCopyJump: false,
        maxBounds: [[-85, -180], [85, 180]],
        maxBoundsViscosity: 1.0,
        minZoom: 3,
        maxZoom: 19
    }).setView([-7.49, 110.0], 7);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        noWrap: true,
        bounds: [[-85, -180], [85, 180]],
        minZoom: 2,
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    map.createPane('historyPane');
    map.getPane('historyPane').style.zIndex = 620;

    const portLayer = L.layerGroup().addTo(map);
    const historyLayer = L.layerGroup().addTo(map);

    function interpolateColor(t) {
        const colors = [
            { r: 59, g: 130, b: 246 },  // blue
            { r: 139, g: 92, b: 246 },  // purple
            { r: 236, g: 72, b: 153 }   // pink
        ];
        const idx = t * (colors.length - 1);
        const i = Math.floor(idx);
        const f = idx - i;
        if (i >= colors.length - 1) return `rgb(${colors[colors.length-1].r},${colors[colors.length-1].g},${colors[colors.length-1].b})`;
        const c1 = colors[i], c2 = colors[i + 1];
        const r = Math.round(c1.r + (c2.r - c1.r) * f);
        const g = Math.round(c1.g + (c2.g - c1.g) * f);
        const b = Math.round(c1.b + (c2.b - c1.b) * f);
        return `rgb(${r},${g},${b})`;
    }

    function formatTime(date) {
        return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    const currentSailId = 1;

    const portIcon = L.divIcon({
        className: 'port-icon',
        html: `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="12" fill="white"/>
          <path fill="#4361EE" d="M13 9V7.82C14.16 7.4 15 6.3 15 5c0-1.65-1.35-3-3-3S9 3.35 9 5c0 1.3.84 2.4 2 2.82V9H9c-.55 0-1 .45-1 1s.45 1 1 1h2v8.92c-2.22-.33-4.59-1.68-5.55-3.37l1.14-1.14c.22-.22.19-.57-.05-.75L3.8 12.6a.5.5 0 0 0-.8.4v2c0 3.88 4.92 7 9 7s9-3.12 9-7v-2a.5.5 0 0 0-.8-.4l-2.74 2.05c-.24.18-.27.54-.05.75l1.14 1.14c-.96 1.69-3.33 3.04-5.55 3.37V11h2c.55 0 1-.45 1-1s-.45-1-1-1zm-1-5c.55 0 1 .45 1 1s-.45 1-1 1s-1-.45-1-1s.45-1 1-1" />
        </svg>
        `,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });

    async function loadPorts() {
        showLoader();
        try {
            const res = await fetch('http://localhost:5000/api/Ports');
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const apiPorts = await res.json();

            portLayer.clearLayers();

            apiPorts.forEach(port => {
                const lat = port.location.y;
                const lon = port.location.x;
                const name = port.name;

                const m = L.marker([lat, lon], {icon: portIcon});
                m.bindTooltip(name);
                m.addTo(portLayer);
            });

        } catch (err) {
            console.error('Error loading ports:', err);
        } finally {
            hideLoader();
        }
    }

    async function renderShipHistory(sailId) {
        showLoader();
        try {
            const res = await fetch(`http://localhost:5000/api/PositionHistories/sail/${sailId}`);
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const data = await res.json();

            historyLayer.clearLayers();

            if (!data || data.length === 0) return;

            data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            const startDate = new Date(data[0].timestamp);
            const endDate = new Date(data[data.length - 1].timestamp);
            document.getElementById('start-time').textContent = formatTime(startDate);
            document.getElementById('end-time').textContent = formatTime(endDate);

            for (let i = 0; i < data.length - 1; i++) {
                const p1 = [data[i].coordinates.y, data[i].coordinates.x];
                const p2 = [data[i + 1].coordinates.y, data[i + 1].coordinates.x];
                const t = i / (data.length - 1);
                const color = interpolateColor(t);

                L.polyline([p1, p2], {
                    pane: 'historyPane',
                    color: color,
                    weight: 4,
                    opacity: 0.85
                }).addTo(historyLayer);
            }

            data.forEach((point, index) => {
                const lat = point.coordinates.y;
                const lng = point.coordinates.x;
                const date = new Date(point.timestamp);
                const isLatest = index === data.length - 1;
                const t = index / (data.length - 1);

                let marker;
                if (isLatest) {
                    marker = L.marker([lat, lng], {
                        pane: 'historyPane',
                        icon: L.divIcon({
                            className: '',
                            html: '<div class="pulse-marker"></div>',
                            iconSize: [22, 22],
                            iconAnchor: [11, 11]
                        })
                    });
                } else {
                    marker = L.circleMarker([lat, lng], {
                        pane: 'historyPane',
                        radius: 5,
                        fillColor: interpolateColor(t),
                        color: '#fff',
                        weight: 2,
                        fillOpacity: 0.9
                    });
                }

                marker.bindTooltip(`
                    <div>
                        <strong>${formatTime(date)}</strong><br>
                        <span style="color:#aaa">Lat:</span> ${lat.toFixed(4)} &nbsp;
                        <span style="color:#aaa">Lng:</span> ${lng.toFixed(4)}<br>
                        <span style="color:#aaa">Speed:</span> ${point.speedKnots} kts &nbsp;
                        <span style="color:#aaa">Heading:</span> ${point.headingDegrees}¬∞
                    </div>
                `, { direction: 'top', className: 'custom-tooltip' });

                marker.addTo(historyLayer);
            });

        } catch (err) {
            console.error('Error rendering history:', err);
        } finally {
            hideLoader();
        }
    }

    L.Control.Refresh = L.Control.extend({
        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            var button = L.DomUtil.create('a', 'leaflet-control-refresh-btn', container);
            button.href = '#';
            button.title = 'Refresh History & Ports';
            button.role = 'button';
            button.innerHTML = '‚Üª';

            button.style.fontSize = '22px';
            button.style.fontWeight = 'bold';
            button.style.width = '30px';
            button.style.height = '30px';
            button.style.lineHeight = '30px';
            button.style.textAlign = 'center';
            button.style.textDecoration = 'none';
            button.style.color = 'black';
            button.style.display = 'block';
            button.style.backgroundColor = 'white';
            button.style.cursor = 'pointer';

            L.DomEvent.on(button, 'click', function (e) {
                L.DomEvent.stop(e);
                console.log("Manual refresh triggered.");
                loadPorts();
                renderShipHistory(currentSailId);
            });

            L.DomEvent.disableClickPropagation(container);
            return container;
        }
    });
    new L.Control.Refresh({position: 'topleft'}).addTo(map);

    loadPorts();
    renderShipHistory(currentSailId);

    setInterval(loadPorts, 5000);
    setInterval(() => renderShipHistory(currentSailId), 5000);

</script>
</body>
</html>